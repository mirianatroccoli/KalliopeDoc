Servizi telefonici avanzati
====

Audioconferenza
-----

.. note::
   Il servizio di audioconferenza è stato profondamente modificato a partire dalla versione di firmware 4.7.12, in cui è stato introdotta la modalità "dial-out" e la disponibilità di un pannello web di supervisione e monitoraggio della stanza di conferenza in tempo reale, in grado di mostrare lo stato dei partecipanti alla conferenza ed effettuare alcune operazioni di gestione (espulsione o invito di partecipanti, disattivazione dell'audio proveniente da uno o più partecipanti, ecc.)

   
Il servizio di audioconferenza disponibile su KallipePBX permette di configurare più stanze con differenti caratteristiche, gestibili e monitorabili in modo autonomo da singoli utenti (anche non amministratori) della centrale.

Per ciascuna stanza è possibile attivare la modalità di accesso "dial-in" e/o la modalità di accesso "dial-out".

La modalità "dial-in" prevede che i partecipanti accedano al servizio chiamando un determinato numero e siano inseriti nella stanza previo inserimento di un PIN di accesso (inviato tramite toni DTMF). L'accesso ad una specifica stanza dial-in può avvenire secondo differenti modalità:

- **accesso con selezione interattiva della stanza**: il servizio di audioconferenza ha associata una selezione all'interno del piano di numerazione, il cui valore predefinito è 802; chiamando tale selezione da un interno una voce guida chiede di inserire il numero della stanza a cui collegarsi. In base alla configurazione della stanza può essere richiesto, dalla voce guida, l'inserimento di un PIN di accesso.
- **accesso diretto ad una specifica stanza**: si effettua una chiamata alla selezione associata al servizio concatenata al numero della stanza (es. 8021234, nel caso che il codice del servizio sia 802 e si voglia accedere alla stanza 1234). Anche in questo caso la voce guida richiederà l'inserimento del PIN di accesso, se previsto per la stanza.
Entrambe queste modalità sono fruibili anche da chiamanti esterni, configurando DID (sulle linee di ingresso) o inoltri (nel piano di numerazione oppure come uscite di IVR, o di altre entità telefoniche) verso la destinazione "Servizio audioconferenza" e selezionando la voce "Chiedi numero della stanza" o una delle stanze presenti.

La modalità "dial-out" prevede invece che sia la centrale stessa a chiamare i singoli partecipanti configurati, nel momento in cui viene dato dalla GUI il comando di avvio della stessa.

In una stessa stanza possono convivere sia partecipanti "dial-out" che partecipanti "dial-in" (se la configurazione lo permette); un pannello web di stato della stanza permette di monitorare in tempo reale l'operatività della stessa e dei relativi partecipanti, con la possibilità di effettuare operazioni di gestione quali il MUTE (e l'UNMUTE) di uno o più partecipanti, l'espulsione di un partecipante dalla stanza, o la sua chiusura (con conseguente espulsione di tutti i partecipanti).

Configurazione delle stanze
++++++++
La configurazione delle stanze di conferenza avviene in 2 fasi. Nella prima fase deve essere semplicemente definita la stanza, assegnandogli una identità (numero della stanza) ed alcuni parametri accessori. Una volta che sia stata creata la stanza (applicando le modifiche), è possibile passare alla fase di configurazione operativa. In questa seconda fase di configurazione è possibile definire la natura della stanza (dial-in e/o dial-out), specificare il comportamento all'ingresso di un nuovo partecipante (es. nel caso dial-in se richiedere un pin di accesso) oppure predisporre una lista di contatti (interni e/o esterni) che devono essere contattati dalla centrale al momento di attivazione della componente dial-out.

Creazione e configurazione stanza di audioconferenza
........
La configurazione di una stanza di conferenza si effettua dal pannello "Applicazioni PBX" > "Servizio Audioconferenza". Il pannello mostra la lista delle stanze esistenti, con i principali attributi. Per aggiungere una nuova stanza, o modificarne una esistente, è necessario acquisire il lock di scrittura. Per modificare una stanza esistente è necessario cliccare sull'icona di Modifica (matita); per aggiungere una nuova stanza si clicca invece sul link "Aggiungi nuova stanza" presente subito sopra l'elenco delle stanze. In entrambi i casi si apre la pagina di modifica della stanza, in cui si devono inserire i seguenti parametri:

Impostazioni generali
..........

- **Abilitato**: checkbox di abilitazione della stanza. Se si disabilita una stanza questa non sarà più utilizzabile, ma i relativi parametri di configurazione ed operativi vengono mantenuti al valore corrente.
- **Numero**: è l'identificativo primario della stanza, e deve essere numerico. Viene utilizzato dal sistema per identificare la stanza; nel caso di stanze con modalità dial-in, questa è la selezione che deve essere digitata al momento della richiesta o concatenata al codice di accesso al servizio.
- **Nome**: è il nome assegnato alla stanza, ed ha una funzione mnemonica e non operativa; viene utilizzato nelle varie select di selezione della stanza quando si configura un inoltro al servizio di audioconferenza, e si vuole specificare la stanza.


Impostazioni Dial-out
.........
Queste impostazioni sono necessarie nel caso in cui si voglia utilizzare la stanza in modalità Dial-out; nel caso in cui la stanza sia utilizzata nella sola modalità Dial-in questi parametri possono essere non impostati. I due parametri sono l'Identità e la Classe di instradamento di uscita e sono utilizzati dalla centrale quando deve effettuare le chiamate verso i partecipanti esterni che devono essere aggiunti alla stanza nella modalità Dial-out. La Classe di instradamento viene utilizzata per determinare l'instradamento sulle varie linee di uscita della specifica chiamata, mentre l'identità viene utilizzata per effettuare l'impostazione del numero chiamante

Utenti abilitati alla modifica operativa
........
Questo elenco raccoglie gli utenti che, indipendentemente dai permessi derivanti dal proprio ruolo, hanno la possibilità di effettuare modifiche alla configurazione operativa della stanza. Le attività di configurazione operativa su una stanza includono la modifica del PIN di accesso, la selezione della musica di attesa riprodotta nella stanza quando vi è un solo partecipante, l'abilitazione della funzione Dial-in e/o Dial-out, ecc. ma non quelle di supervisione e pilotaggio in tempo reale, che possono essere assegnate a differenti utenti.


Configurazione operativa
+++++++
Una volta creata la stanza è possibile procedere con la sua configurazione operativa, passando al tab "Configurazione operativa stanze", che elenca tutte le stanze definite, riassumendone i parametri operativi principali.

Ciascuna stanza può trovarsi nello stato "closed" (chiusa) oppure "open" (aperta). E' possibile modificare i parametri operativi di una stanza solo quando si trova nello stato "closed", cliccando sull'icona di Edit (matita)in fondo alla riga della tabella. Il passaggio dallo stato "closed" a quello "open" può avvenire in due modalità, una manuale ed una automatica. La modalità manuale è comandata da un utente abilitato (vedi sotto per quanto riguarda i permessi di supervisione e pilotaggio) cliccando sul pulsante corrispondente, adiacente a quello di modifica della configurazione operativa. L'apertura automatica è disponibile solo per le stanze per le quali è attiva la modalità Dial-in, ed avviene nel momento in cui un qualsiasi interno accede alla stanza.

La pagina di configurazione operativa della stanza è divisa in diverse sezioni; la prima sezione contiene delle impostazioni generali, che sono:

- **Lingua**: la lingua con la quale devono essere riprodotti ai partecipanti i vari prompt audio (es. la richiesta del PIN, oppure il messaggio di ingresso di un nuovo utente nella conferenza)
- **PIN di amministrazione**: il PIN di accesso alla stanza in modalità amministratore (admin); si noti che possono essere più utenti amministratori all'interno della stessa stanza di conferenza. Le peculiarità degli utenti amministratore sono per il momento associate alla funzione opzionale di espulsione automatica di tutti i partecipanti, al momento in cui l'ultimo utente amministratore esce dalla stanza
- **PIN**: il PIN di accesso alla stanza in modalità partecipante standard
- **Annunci abilitati**: flag che se abilitato richiede ai partecipanti che entrano nella conferenza di pronunciare il proprio nome, al fine di effettuarne l'annuncio ai partecipanti già presenti preliminarmente all'inserimento e a seguito di uscita dalla stanza
- **Espelli utenti su uscita ultimo admin**: flag che attiva la funzione di espulsione di tutti gli utenti presenti nella stanza di conferenza nel momento in cui l'ultimo partecipante con ruolo amministratore esce dalla stanza
- **Abilita ottimizzazione mixing**: permette di ottimizzare la qualità audio della stanza e le performance evitando di miscelare l'audio proveniente da partecipanti che non stanno parlando (Silence Suppression, o Talker Optimization) o comunque sotto una certa soglia di rilevazione (VAD - Voice Activity Detection). In questo modo viene ridotto il rumore di fondo della stanza, ma viene normalmente introdotto un breve clipping nell'audio dei partecipanti quando iniziano a parlare, tipico di tutti i sistemi con VAD, poiché il PBX deve rilevare il superamento di un determinato livello di intensità audio prima di considerare il partecipante come attivo. L'ottimizzazione mixing non modifica in modo significativo le performance del sistema in quanto il guadagno di computing relativo alla decodifica e miscelazione di un flusso audio in meno è compensato dal carico necessario ad effettuare la rilevazione del parlato (VAD - Voice Activity Detection), mentre la parte più onerosa dell'attività è la codifica del flusso audio risultante per inviarlo ai vari partecipanti, e questo è un contributo che rimane costante indipendentemente dal numero dei parlanti attivi
- **File della musica di attes**a: mentre vi è un unico partecipante nella stanza, è possibile riprodurre un file audio invece di lasciarlo nel silenzio; cliccando su "Scegli file" si apre la finestra del Sistema Operativo per poter selezionare il file audio da utilizzare.


La sezione Dial-in contiene solo la casella di spunta per l'abilitazione del servizio Dial-in; se si disabilita la modalità Dial-in non sarà più possibile accedere alla stanza effettuando una chiamata al servizio di Audioconferenza, ma si dovrà essere chiamati da essa, nella modalità Dial-out.

La sezione Dial-out raccoglie le impostazioni relative alla modalità omonima, in cui è il Kalliope ad effettuare le chiamate verso i partecipanti configurati, unendoli alla conferenza nel momento della risposta. I parametri configurabili sono:

- **Abilitazione Dial-out**: flag che determina se la modalità Dial-out è abilitata per questa stanza. Per poter utilizzare la modalità Dial-out con partecipanti esterni è necessario che nel pannello di configurazione della stanza siano state assegnate l'identità e la classe di instradamento di uscita da utilizzare per effettuare la chiamata uscente. In caso contrario non sarà possibile per la stanza effettuare chiamate verso i numeri esterni
- **Numero massimo di tentativi di chiamata per partecipante**: indica il numero massimo di tentativi di chiamata che possono essere effettuati per ciascun partecipante; una chiamata da parte della stanza verso uno dei partecipanti può difatti fallire per vari motivi (utenza occupata, o momentanemanete non raggiungibile, oppure utente che non accetta la chiamata). Nel momento in cui una chiamata fallisce (nel caso in cui la politica di invito di quel partecipante sia "automatica, con ripetizione") il sistema può effettuare un nuovo tentativo di chiamata, fino al raggiungimento del numero massimo qui configurato
- **Abilita riproduzione file audio stanza completa/incompleta e realtivi pulsanti di selezione dei file**: nel caso di utilizzo della stanza in modalità Dial-out, è possibile iniettare nella stanza un file audio differente nel caso in cui la stanza sia "completa" o "incompleta"; lo stato di completezza della stanza è valutato dal Kalliope in base alla presenza nella stanza di tutti i partecipanti Dial-out marcati come "obbligatori". Questa funzione può essere utile, in caso di stanze non supervisionate, per far sapere ai presenti nella stanza se manca qualcuno tra i partecipanti la cui presenza è marcata come richiesta.


A seguire è presente un elenco dei partecipanti Dial-out, che saranno quindi contattati dalla centrale in base alla rispettiva politica di invito nella stanza. Per aggiungere un partecipante si clicca sull'icona + (Aggiungi partecipante); viene inserita una nuova riga nella lista con cui specificare il partecipante, che può essere un interno del PBX (tipo "Interno") o un numero esterno ("Esterno"); nel primo caso il campo "Contatto" è una lista da cui selezionare uno degli interni della centrale, mentre nel secondo caso nel campo "Contatto" deve essere inserito il numero esterno da chiamare (privo del prefisso di impegno linea esterna). In quest'ultimo caso è possibile specificare anche il nome del partecipante, che sarà mostrato nel pannello di supervisione e gestione della stanza, quando questa è aperta. Per ciascun partecipante Dial-out è possibile scegliere una diversa politica di invito nella stanza, tra le 3 possibili: Automatica con o senza ripetizione, oppure manuale. I dettagli di funzioanmento delle tre politiche sono spiegate in seguito, nella sezione di descrizione del funzionamento del pannello di supervisione e gestione della stanza.

La politica di invito automatico prevede che la stanza effettui le chiamate verso i relativi partecipanti, in modo automatizzato a partire dal momento in cui l'utente che sta gestendo la stanza (che deve essere precedentemente messa nello stato "Aperto") effettui l'avvio del meccanismo di invito. Le chiamate vengono effettuate in modo parallelo; nel caso di partecipanti esterni, al momento della risposta il sistema si deve assicurare che la chiamata sia stata risposta da una persona e nno da un servizio automatico (messaggi di cortesia, o caselle vocali), per cui viene richiesta l'accettazione della chiamata mediante digitazione del tasto "1". In caso di ricezione del tono, la centrale inserisce il partecipante in conferenza, altrimenti si comporta come se la chiamata non sia stata risposta, e dopo un timeout la abbatte. In caso di fallimento di una chiamata, se la politica di invito per quel partecipante è "Automatica senza ripetizione", lo stato del partecipante viene impostato a "Fuori stanza", e se è marcato come "obbligatorio" si attiva (se abilitata) la riproduzione del file audio di stanza incompleta. Se la politica è invece "Automatica con ripetizione", il sistema effettuerà ulteriori tentativi fino al raggiungimento del numero massimo configurato per la stanza. Nel caso di politica di invito "Manuale", il partecipante non viene chiamato dalla centrale all'avvio del meccanismo di invito, ma deve essere comandata singolarmente per ciascuno di essi l'esecuzione della chiamata. Questa modalità di invito è sempre singola; in caso di fallimento un successivo tentativo può essere effettuato solo comandando manualmente una nuova chiamata.

L'ultima sezione del pannello permette di definire gli utenti che sono autorizzati ad effettuare le operazioni di supervisione e gestione della stanza, in aggiunta a quelli abilitati alla configurazione operativa (per ruolo - per i quali è necessaria l'abilitazione in scrittura - o perché specificati nel pannello di configurazione della stanza). 

**NOTA**: gli interni associati agli utenti che sono abilitati alla gestione della stanza possono entrare nella stessa in modalità dial-in (se abilitata), come amministratori, senza necessità di digitare il PIN

Gli utenti abilitati alla gestione della stanza visualizzeranno nella GUI il pulsante "Apri stanza" (icona play) per comandare l'apertura manuale della stanza (se chiusa) o il pulsante "Visualizza stato e gestisci stanza" (lente) per accedere al pannello di supervisione e gestione (se aperta).

Supervisione e gestione della stanza
+++++++++
Ciascuna stanza di conferenza può trovarsi, ad un dato istante, in uno di questi tre stati: "chiusa", "aperta", "aperta e attiva". Il passaggio tra questi 3 stati può avvenire in modo automatico o manuale, secondo una specifica macchina a stati.

Come indicato in precedenza, l'apertura di una stanza di conferenza può avvenire in modalità manuale o automatica. In modalità manuale, uno degli utenti abilitati alla sua gestione ne comanda esplicitamente l'apertura cliccando sul pulsante "Apri stanza" (icona play) Nel caso di stanza abilitata alla modalità dial-in, la stanza viene automaticamente aperta nel momento in cui un interno vi entra. In entrambi i casi, l'icona di stato presente nel pannello di configurazione operativa delle stanze si trasforma in una lente, e viene inibita la possibilità di apportare modifiche alla configurazione operativa; per poter apportare modifiche alla configurazione operativa della stanza è necessario prima chiuderla (entrando nel pannello di gestione della stessa). Lo stato "aperta e attiva" (o più brevemente "attiva") indica che per quella stanza è attivo il servizio di invito dial-out dei partecipanti (per quelli caratterizzati da una politica di invito automatico)

L'utente, cliccando sull'icona "Visualizza stato e gestisci stanza" accede al pannello di supervisione e gestione della stessa, suddiviso in 3 sezioni.

Nella prima sezione ("Informazioni stanza") sono riportati il nome ed il numero della stessa, ed il relativo stato, che può essere "Aperta" o "Attiva"; nel primo caso la stanza è operativa ma gli inviti automatici sono arrestati, mentre nel secondo caso la centrale si occupa di effettuare le chiamate automatiche verso i partecipanti con politica di invito automatico, e di ripetere l'invito nel caso in cui uno di tali partecipanti esca per qualsiasi motivo. Accanto allo stato è presente un pulsante a forma di X che permette di espellere tutti i partecipanti e tornare allo stato di stanza "chiusa".

La seconda sezione ("Dial-out") riporta le informazioni di stato relative a questa modalità della stanza, ed i pulsanti utilizzabili per comandarne le operazioni. Il primo flag "Dial-out automatico" indica se la funzione di invito automatico dei partecipanti è attiva o inattiva; in caso di servizio di invito inattivo, è possibile avviarlo cliccando sull'icona "Play" adiacente; in caso di servizio attivo, il pulsante "Stop" permette di espellere tutti i partecipanti e arrestare il meccanismo di invito automatico.

L'indicatore di stato seguente indica se la stanza è completa o incompleta, in base alla presenza dei partecipanti che sono marcati come obbligatori. Se anche uno solo dei partecipanti obbligatori si trova fuori dalla stanza (salvo che sia stato messo in stato "Sospeso" - vedi sotto per gli stati possibili dei partecipanti alla stanza) allora la stanza è considerata incompleta, altrimenti è nello stato completa. In ciascuno dei due stati può essere riprodotto un file audio di sottofondo nella stanza di conferenza per informare i partecipanti della condizione.

Nella parte bassa del pannello è presente la lista dei partecipanti alla stanza di conferenza, in forma di tabella; per ciasun partecipante si hanno le seguenti informazioni ed un set di azioni effettuabili (in funzione della natura e dello stato del partecipante):


- **Nome**: Identità dell'interno oppure nome assegnato in fase di aggiunta del partecipante alla stanza
- **Selezione**: Numero dell'interno, oppure numero esterno
- **Politica di chiamata**: modalità con la quale il partecipante viene inserito nella stanza di conferenza. Nel caso di partecipanti dial-out, la politica può essere manuale o automatica (con 1 singolo tentativo di chiamata, oppure con ripetizione fino al numero massimo di tentativi configurati per la stanza). In questa lista compaiono anche gli eventuali partecipanti dial-in, che quindi sono entrati nella stanza chiamando il servizio di audioconferenza, selezionando la stanza e digitando il relativo PIN. A questi utenti risulta associata la modalità manuale.
- **Richiesto**: flag che indica se la presenza del partecipante è obbligatoria per la valutazione dello stato di completezza della stanza. Gli utenti dial-in hanno sempre questo flag disabilitato
- **Dinamico**: flag che indica se il partecipante è configurato in modo statico come appartenente alla stanza (partecipante dial-out definito nella pagina di configurazione operativa della stanza) oppure se è presente solo in modo temporaneo. Un partecipante può essere presente in via temporanea in due casi: se si tratta di partecipante dial-in, oppure se viene aggiunto dinamicamente mediante il pulsante "Aggiungi partecipante dial-out" presente nella sezione "Dial-out" precedente. In caso di chiusura di una stanza, tutti i partecipanti temporanei vengono cancellati, ed una successiva apertura vedrà quindi come partecipanti i soli utenti configurati staticamente; in caso di apertura automatica della stanza a seguito di ingresso di un utente dial-in, allora anche tale utente sarà presente in modalità "Dinamica".
- **Direzione**: indica se il partecipante è di tipo dial-out o dial-in. In caso di utente dial-in, se questo chiude la conversazione o se viene espulso da GUI, oppure se la stanza viene arrestata senza essere chiusa, questo rimane nella lista dei partecipanti. E' possibile cliccare sull'icona della cornetta telefonica presente nella colonna "Azioni" per farlo chiamare dalla stanza di audioconferenza, di fatto trasformandolo in partecipante dial-out dinamico ad invito manuale.
- **Stato**: ciascun partecipante può trovarsi in uno dei seguenti stati:
  - **Fuori dalla stanza**: l'utente non sta partecipando alla conferenza; è la condizione iniziale quando la stanza è aperta ma non ancora attiva (quindi gli inviti automatici sono disabilitati).
  - **Nella stanza:** l'utente è all'interno della stanza e partecipa all'audioconferenza.
  - **Invitato**: il KalliopePBX sta effettuando la chiamata verso il partecipante per inserirlo nella stanza. L'esito di questo tentativo di chiamata può essere negativo (utente occupato, non risponde, non accetta l'inserimento) nel qual caso il sistema può ripetere il tentativo di chiamata (se il partecipante ha una politica di invito automatica con ripetizione, e non sono stati esauriti i tentativi configurati) oppure marcare l'utente come "Fuori dalla stanza". Se invece la chiamata ha esito positivo (l'utente riceve la chiamata e accetta l'inserimento nella stanza) allora questo passa nello stato "Nella stanza".
  - **Sospeso**: questo stato esclude temporaneamente un partecipante dalla stanza, ne sospende gli inviti e lo esclude dal computo dei partecipanti che concorrono alla valutazione di completezza della stanza.
  
  
  Le azioni disponibili per ciascun partecipante riguardano la sua partecipazione alla stanza e l'abilitazione o disabilitazione del suo microfono. Le azioni disponibili dipendono dallo stato dell'utente:

- se l'utente si trova nello stato "Fuori dalla stanza" ed ha una politica di invito manuale, oppure la stanza ha il servizio di invito non attivo, oppure ancora il servizio di invito è attivo ma sono terminati tutti i tentativi di invito per questo utente, sono disponibili le azioni "Invita" (cornetta) e "Sospendi" (icona stop). La prima azione effettua la chiamata verso la selezione dell'utente per inserirlo nella stanza (con eventuali ripetizioni in caso di insuccesso, se previsto per questo utente); la seconda lo porta nello stato "Sospeso".
- se l'utente si trova nello stato "Sospeso" è disponibile l'azione "Invita", che causa l'esecuzione di una chiamata verso la selezione dell'utente per inserirlo nella stanza (con le eventuali ripetizioni, come indicato sopra).
- se l'utente di trova nello stato "Nella stanza" è disponibile l'azione "Riaggancia" che abbatte la chiamata di questo utente e, nel caso in cui l'utente abbia politica di chiamata automatica, ne sospende l'esecuzione, per evitare che venga nuovamente reinserito in conferenza).

E' inoltre possibile andare a comandare il "mute" (disabilitazione del microfono) per i partecipanti che si trovano nella stanza, singolarmente o per tutti i partecipanti; nel primo caso la commutazione dello stato del microfono si effettua cliccando sull'icona a forma di microfono presente nella colonna "Azioni", mentre per agire su tutti i partecipanti si utilizzano i due pulsanti presenti sopra la lista dei partecipanti (e che riportano le voci "Disabilita tutti i microfoni" e "Abilita tutti i microfoni").

